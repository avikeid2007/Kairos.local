<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="KaiROS.Mobile.Views.ChatPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:controls="clr-namespace:KaiROS.Mobile.Controls"
    xmlns:models="clr-namespace:KaiROS.Mobile.Models"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:viewmodels="clr-namespace:KaiROS.Mobile.ViewModels"
    Title="Chat"
    x:DataType="viewmodels:ChatViewModel"
    BackgroundColor="#0D0D1A"
    Shell.FlyoutBehavior="Disabled"
    Shell.NavBarIsVisible="False">

    <Grid RowDefinitions="Auto,Auto,*,Auto">

        <!--  Header with gradient border effect  -->
        <Border
            Grid.Row="0"
            Margin="16,12"
            Padding="1.5"
            Stroke="Transparent"
            StrokeShape="RoundRectangle 14">
            <Border.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Offset="0.0" Color="#7B2CBF" />
                    <GradientStop Offset="0.5" Color="#3B82F6" />
                    <GradientStop Offset="1.0" Color="#7B2CBF" />
                </LinearGradientBrush>
            </Border.Background>

            <Border
                Padding="14,10"
                BackgroundColor="#12122A"
                Stroke="Transparent"
                StrokeShape="RoundRectangle 12">
                <Grid ColumnDefinitions="Auto,*,Auto">

                    <!--  New Chat Button with Gradient  -->
                    <Border
                        HeightRequest="32"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 8"
                        WidthRequest="32">
                        <Border.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                <GradientStop Offset="0.0" Color="#7B2CBF" />
                                <GradientStop Offset="1.0" Color="#3B82F6" />
                            </LinearGradientBrush>
                        </Border.Background>
                        <Label
                            FontSize="18"
                            HorizontalOptions="Center"
                            Text="+"
                            TextColor="White"
                            VerticalOptions="Center">
                            <Label.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ClearChatCommand}" />
                            </Label.GestureRecognizers>
                        </Label>
                    </Border>

                    <!--  Title  -->
                    <Label
                        Grid.Column="1"
                        FontAttributes="Bold"
                        FontSize="18"
                        HorizontalOptions="Center"
                        Text="KaiROS AI"
                        TextColor="White"
                        VerticalOptions="Center" />

                    <!--  Document Attachment Button  -->
                    <HorizontalStackLayout Grid.Column="2" Spacing="8">
                        <!--  Document Status  -->
                        <Label
                            FontSize="12"
                            IsVisible="{Binding HasDocuments}"
                            Text="{Binding DocumentStatusText}"
                            TextColor="#7B2CBF"
                            VerticalOptions="Center" />

                        <!--  Add Document Button  -->
                        <Border
                            BackgroundColor="#1E1E3A"
                            HeightRequest="32"
                            Stroke="#2A2A50"
                            StrokeShape="RoundRectangle 8"
                            WidthRequest="32">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding AddDocumentCommand}" />
                            </Border.GestureRecognizers>
                            <Label
                                FontSize="16"
                                HorizontalOptions="Center"
                                Text="ðŸ“Ž"
                                VerticalOptions="Center" />
                        </Border>
                    </HorizontalStackLayout>

                </Grid>
            </Border>
        </Border>

        <!--  Status Bar  -->
        <Border
            Grid.Row="1"
            Padding="16,8"
            BackgroundColor="#15152A"
            Stroke="Transparent">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <HorizontalStackLayout Spacing="8">
                    <Ellipse
                        Fill="{Binding IsModelLoaded, Converter={StaticResource BoolToStatusColorConverter}}"
                        HeightRequest="8"
                        VerticalOptions="Center"
                        WidthRequest="8" />
                    <Label
                        FontSize="12"
                        Text="{Binding StatusText}"
                        TextColor="#9090B0"
                        VerticalOptions="Center" />
                </HorizontalStackLayout>

                <Label
                    Grid.Column="2"
                    FontSize="11"
                    Text="{Binding StatsText}"
                    TextColor="#7070A0"
                    VerticalOptions="Center" />
            </Grid>
        </Border>

        <!--  Chat Messages  -->
        <CollectionView
            Grid.Row="2"
            Margin="12,8"
            ItemsSource="{Binding Messages}"
            ItemsUpdatingScrollMode="KeepLastItemInView">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:ChatMessage">
                    <Grid Margin="0,6">

                        <!--  User Message with gradient fill  -->
                        <Border
                            Padding="14,10"
                            HorizontalOptions="End"
                            IsVisible="{Binding Role, Converter={StaticResource RoleToUserVisibilityConverter}}"
                            MaximumWidthRequest="280"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 18,18,4,18">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                    <GradientStop Offset="0.0" Color="#3B82F6" />
                                    <GradientStop Offset="1.0" Color="#8B5CF6" />
                                </LinearGradientBrush>
                            </Border.Background>
                            <Label
                                FontSize="14"
                                LineBreakMode="WordWrap"
                                Text="{Binding Content}"
                                TextColor="White" />
                        </Border>

                        <!--  Assistant Message with gradient border  -->
                        <Border
                            Padding="1.5"
                            HorizontalOptions="Start"
                            IsVisible="{Binding Role, Converter={StaticResource RoleToAssistantVisibilityConverter}}"
                            MaximumWidthRequest="450"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 4,18,18,18">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                    <GradientStop Offset="0.0" Color="#7B2CBF" />
                                    <GradientStop Offset="0.5" Color="#3B82F6" />
                                    <GradientStop Offset="1.0" Color="#7B2CBF" />
                                </LinearGradientBrush>
                            </Border.Background>

                            <Border
                                Padding="14,10"
                                BackgroundColor="#12122A"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 2,16,16,16">
                                <VerticalStackLayout>

                                    <!--  Markdown Content  -->
                                    <controls:MarkdownView Text="{Binding Content}" VerticalOptions="Start" />

                                    <!--  Typing dots  -->
                                    <HorizontalStackLayout
                                        Margin="0,6,0,0"
                                        IsVisible="{Binding IsStreaming}"
                                        Spacing="4">
                                        <Ellipse
                                            Fill="#7B2CBF"
                                            HeightRequest="6"
                                            WidthRequest="6" />
                                        <Ellipse
                                            Fill="#7B2CBF"
                                            HeightRequest="6"
                                            Opacity="0.6"
                                            WidthRequest="6" />
                                        <Ellipse
                                            Fill="#7B2CBF"
                                            HeightRequest="6"
                                            Opacity="0.3"
                                            WidthRequest="6" />
                                    </HorizontalStackLayout>

                                    <!--  Action Buttons (Copy/Speak)  -->
                                    <HorizontalStackLayout
                                        Margin="0,8,0,0"
                                        HorizontalOptions="End"
                                        IsVisible="{Binding IsStreaming, Converter={StaticResource InvertBoolConverter}}"
                                        Spacing="12">

                                        <!--  Speak Button  -->
                                        <ImageButton
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ChatViewModel}}, Path=SpeakResponseCommand}"
                                            CommandParameter="{Binding .}"
                                            HeightRequest="16"
                                            Opacity="0.5"
                                            Source="{Binding IsSpeaking, Source={RelativeSource AncestorType={x:Type viewmodels:ChatViewModel}}, Converter={StaticResource BoolToMicIconConverter}}"
                                            WidthRequest="16">
                                            <ImageButton.Behaviors>
                                                <toolkit:IconTintColorBehavior TintColor="#A0A0C0" />
                                            </ImageButton.Behaviors>
                                        </ImageButton>

                                        <!--  Copy Button  -->
                                        <ImageButton
                                            Padding="0"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ChatViewModel}}, Path=CopyMessageCommand}"
                                            CommandParameter="{Binding Content}"
                                            HeightRequest="8"
                                            Opacity="0.5"
                                            Source="icon_copy.png"
                                            WidthRequest="8">
                                            <ImageButton.Behaviors>
                                                <toolkit:IconTintColorBehavior TintColor="#A0A0C0" />
                                            </ImageButton.Behaviors>
                                        </ImageButton>
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Border>
                        </Border>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>

            <!--  Empty State  -->
            <CollectionView.EmptyView>
                <VerticalStackLayout
                    Padding="40"
                    HorizontalOptions="Center"
                    Spacing="12"
                    VerticalOptions="Center">
                    <Label
                        FontSize="48"
                        HorizontalOptions="Center"
                        Text="ðŸ¤–" />
                    <Label
                        FontSize="16"
                        HorizontalOptions="Center"
                        Text="Ask KaiROS anything..."
                        TextColor="#7070A0" />
                    <Label
                        FontSize="13"
                        HorizontalOptions="Center"
                        IsVisible="{Binding IsModelLoaded, Converter={StaticResource InvertBoolConverter}}"
                        Text="Load a model from Models tab"
                        TextColor="#5050A0" />
                </VerticalStackLayout>
            </CollectionView.EmptyView>
        </CollectionView>

        <!--  Input Area with gradient border  -->
        <Border
            Grid.Row="3"
            Padding="12,12"
            BackgroundColor="#15152A"
            Stroke="Transparent">
            <Grid ColumnDefinitions="*,Auto,Auto">

                <!--  Input Field with gradient border  -->
                <Border
                    Padding="1.5"
                    Stroke="Transparent"
                    StrokeShape="RoundRectangle 24">
                    <Border.Background>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                            <GradientStop Offset="0.0" Color="#7B2CBF" />
                            <GradientStop Offset="1.0" Color="#3B82F6" />
                        </LinearGradientBrush>
                    </Border.Background>

                    <Border
                        Padding="16,0"
                        BackgroundColor="#1E1E3A"
                        HeightRequest="44"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 22">
                        <Entry
                            BackgroundColor="Transparent"
                            FontSize="14"
                            IsEnabled="{Binding IsModelLoaded}"
                            Placeholder="Ask KaiROS anything..."
                            PlaceholderColor="#6060A0"
                            ReturnCommand="{Binding SendMessageCommand}"
                            Text="{Binding UserInput}"
                            TextColor="White"
                            VerticalOptions="Center" />
                    </Border>
                </Border>

                <!--  Microphone Button  -->
                <Border
                    Grid.Column="1"
                    Margin="8,0,0,0"
                    BackgroundColor="{Binding IsListening, Converter={StaticResource BoolToStatusColorConverter}}"
                    HeightRequest="44"
                    Stroke="Transparent"
                    StrokeShape="RoundRectangle 22"
                    WidthRequest="44">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding StartVoiceInputCommand}" />
                    </Border.GestureRecognizers>
                    <Label
                        FontSize="18"
                        HorizontalOptions="Center"
                        Text="{Binding IsListening, Converter={StaticResource BoolToMicIconConverter}}"
                        TextColor="White"
                        VerticalOptions="Center" />
                </Border>

                <!--  Send Button with gradient fill  -->
                <Border
                    Grid.Column="2"
                    Margin="8,0,0,0"
                    HeightRequest="44"
                    IsVisible="{Binding IsGenerating, Converter={StaticResource InvertBoolConverter}}"
                    Stroke="Transparent"
                    StrokeShape="RoundRectangle 22"
                    WidthRequest="44">
                    <Border.Background>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                            <GradientStop Offset="0.0" Color="#7B2CBF" />
                            <GradientStop Offset="1.0" Color="#3B82F6" />
                        </LinearGradientBrush>
                    </Border.Background>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SendMessageCommand}" />
                    </Border.GestureRecognizers>
                    <Label
                        FontSize="16"
                        HorizontalOptions="Center"
                        Text="â–¶"
                        TextColor="White"
                        VerticalOptions="Center" />
                </Border>

                <!--  Stop Button  -->
                <Border
                    Grid.Column="2"
                    Margin="8,0,0,0"
                    BackgroundColor="#EF4444"
                    HeightRequest="44"
                    IsVisible="{Binding IsGenerating}"
                    Stroke="Transparent"
                    StrokeShape="RoundRectangle 22"
                    WidthRequest="44">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding StopGenerationCommand}" />
                    </Border.GestureRecognizers>
                    <Label
                        FontSize="12"
                        HorizontalOptions="Center"
                        Text="â– "
                        TextColor="White"
                        VerticalOptions="Center" />
                </Border>
            </Grid>
        </Border>
    </Grid>
</ContentPage>
